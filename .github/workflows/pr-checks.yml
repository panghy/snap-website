name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparisons

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for build artifacts
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^dist/|^build/'; then
            echo "❌ Build artifacts should not be committed"
            echo "Please remove dist/ or build/ files from your PR"
            exit 1
          fi
          echo "✅ No build artifacts found"

      - name: Check for large files
        run: |
          large_files=$(find . -type f -size +1M -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./dist/*" -not -path "./build/*" -not -name "*.lock" -not -name "package-lock.json")
          if [ ! -z "$large_files" ]; then
            echo "❌ Large files detected (>1MB):"
            echo "$large_files"
            echo "Please review if these files are necessary"
            exit 1
          fi
          echo "✅ No large files detected"

      - name: Run build
        run: npm run build

      - name: Run tests
        run: npm run test:run

      - name: Check bundle size
        run: |
          echo "📦 Bundle Size Report"
          echo "====================="

          # Find the main JS bundle
          main_bundle=$(find dist/assets -name "index-*.js" -type f | head -1)

          if [ -f "$main_bundle" ]; then
            size_kb=$(du -k "$main_bundle" | cut -f1)
            echo "Main bundle: ${size_kb}KB"

            # Warn if bundle is over 1MB
            if [ "$size_kb" -gt 1024 ]; then
              echo "⚠️ Warning: Main bundle is over 1MB (${size_kb}KB)"
              echo "Consider code splitting or lazy loading"
            else
              echo "✅ Bundle size is acceptable"
            fi
          else
            echo "Bundle not found - skipping size check"
          fi

      - name: Check test results
        id: test-check
        run: |
          if npm run test:run; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Get bundle size
        id: bundle-size
        run: |
          if [ -d "dist/assets" ]; then
            main_bundle=$(find dist/assets -name "index-*.js" -type f | head -1)
            if [ -f "$main_bundle" ]; then
              size_kb=$(du -k "$main_bundle" | cut -f1)
              echo "bundle_size=${size_kb}KB" >> $GITHUB_OUTPUT
            else
              echo "bundle_size=N/A" >> $GITHUB_OUTPUT
            fi
          else
            echo "bundle_size=N/A" >> $GITHUB_OUTPUT
          fi